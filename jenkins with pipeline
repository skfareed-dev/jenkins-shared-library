pipeline {
    agent any

    parameters {
        string(
            name: 'NEXUS_REGISTRY',
            defaultValue: '13.251.194.219:8083',
            description: 'Nexus Docker registry'
        )
    }

    environment {
        BACKEND_IMAGE  = "node-backend"
        FRONTEND_IMAGE = "node-frontend"
        IMAGE_TAG      = "${BUILD_NUMBER}"
        NEXUS_REPO     = "docker-hosted"

        SONAR_ORG   = "sonar00732"
        SONAR_KEY   = "sonar00732-NodeJS Application"
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'dev',
                    url: 'https://github.com/Inno8tiveltd/online-exam-portal.git'
            }
        }

        stage('SonarQube Analysis') {
    steps {
        script {
            def scannerHome = tool 'SonarScanner'
            withSonarQubeEnv('SonarQube') {
                sh """
                ${scannerHome}/bin/sonar-scanner \
                  -Dsonar.projectKey=sonar00732-NodeJS-Application \
                  -Dsonar.organization=sonar00732 \
                  -Dsonar.sources=frontend,backend
                """
            }
        }
    }
}


        //  stage('Quality Gate') {
        //      steps {
        //          timeout(time: 30, unit: 'MINUTES') {
        //              waitForQualityGate abortPipeline: true
        //      }
        //   }
        // }

        stage('Build Backend Docker Image') {
            steps {
                sh "docker build -t ${BACKEND_IMAGE}:${IMAGE_TAG} backend"
            }
        }

        stage('Build Frontend Docker Image') {
            steps {
                sh "docker build -t ${FRONTEND_IMAGE}:${IMAGE_TAG} frontend"
            }
        }

        stage('Tag & Push to Nexus') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'nexus-docker-creds',
                    usernameVariable: 'NEXUS_USER',
                    passwordVariable: 'NEXUS_PASSWORD'
                )]) {
                    sh '''
                        echo $NEXUS_PASSWORD | docker login $NEXUS_REGISTRY \
                        -u $NEXUS_USER --password-stdin

                        docker tag ${BACKEND_IMAGE}:${IMAGE_TAG} \
                        $NEXUS_REGISTRY/${NEXUS_REPO}/${BACKEND_IMAGE}:${IMAGE_TAG}

                        docker tag ${FRONTEND_IMAGE}:${IMAGE_TAG} \
                        $NEXUS_REGISTRY/${NEXUS_REPO}/${FRONTEND_IMAGE}:${IMAGE_TAG}

                        docker push $NEXUS_REGISTRY/${NEXUS_REPO}/${BACKEND_IMAGE}:${IMAGE_TAG}
                        docker push $NEXUS_REGISTRY/${NEXUS_REPO}/${FRONTEND_IMAGE}:${IMAGE_TAG}

                        docker image prune -f
                    '''
                }
            }
        }
    }

    post {
        success {
            emailext(
                subject: "SUCCESS: ${JOB_NAME} #${BUILD_NUMBER}",
                body: """
Build SUCCESS üéâ

Project: ${JOB_NAME}
Build: ${BUILD_NUMBER}

Docker Images:
${params.NEXUS_REGISTRY}/${NEXUS_REPO}/node-backend:${IMAGE_TAG}
${params.NEXUS_REGISTRY}/${NEXUS_REPO}/node-frontend:${IMAGE_TAG}

Sonar Dashboard:
https://sonarcloud.io/dashboard?id=${SONAR_KEY}
""",
                to: "jsp82767@gmail.com"
            )
        }

        failure {
            emailext(
                subject: "FAILED: ${JOB_NAME} #${BUILD_NUMBER}",
                body: """
Build FAILED ‚ùå

Project: ${JOB_NAME}
Build: ${BUILD_NUMBER}

Check Jenkins Console logs.
""",
                to: "jsp82767@gmail.com"
            )
        }
    }
}
